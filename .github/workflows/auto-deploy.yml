name: Auto Deploy from Codex
on:
  push:
    branches:
      - main

env:
  # These are environment defaults used when not overridden by step env.
  DEPLOY_PORT: 22

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Optional: run Codex generation BEFORE deploy (uncomment if you want the workflow to generate files)
      # - name: Set up Python (for Codex generation)
      #   uses: actions/setup-python@v4
      #   with:
      #     python-version: "3.11"
      #
      # - name: Install dependencies & run Codex generator
      #   env:
      #     OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      #   run: |
      #     pip install -r requirements.txt || true
      #     python scripts/generate_with_codex.py

      - name: Prepare SSH key
        shell: bash
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          mkdir -p "$HOME/.ssh"
          # Write the private key (secret should contain the private key contents)
          printf "%s\n" "$DEPLOY_KEY" > "$HOME/.ssh/deploy_key"
          chmod 600 "$HOME/.ssh/deploy_key"
          # add host key to known_hosts (port-aware)
          if [ -n "${DEPLOY_PORT:-}" ] && [ "$DEPLOY_PORT" != "22" ]; then
            ssh-keyscan -p "$DEPLOY_PORT" -H "$DEPLOY_HOST" >> "$HOME/.ssh/known_hosts" 2>/dev/null || true
          else
            ssh-keyscan -H "$DEPLOY_HOST" >> "$HOME/.ssh/known_hosts" 2>/dev/null || true
          fi

      - name: Rsync files to server
        shell: bash
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          # Exclude .git and CI artifacts; adjust excludes to taste
          RSYNC_EXCLUDES=(
            --exclude='.git'
            --exclude='.github'
            --exclude='tests'
            --exclude='*.pem'
          )
          SSH_CMD="ssh -i $HOME/.ssh/deploy_key -o StrictHostKeyChecking=yes -o IdentitiesOnly=yes -p ${DEPLOY_PORT:-22}"
          rsync -az --delete "${RSYNC_EXCLUDES[@]}" -e "$SSH_CMD" ./ "${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/"

      - name: Run remote WP-CLI tasks (clear cache, run migrations, etc.)
        shell: bash
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          ssh -i "$HOME/.ssh/deploy_key" -o IdentitiesOnly=yes -p ${DEPLOY_PORT:-22} \
            "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "set -e && cd '${DEPLOY_PATH}' && wp cache flush || true"
